name: CI Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Validate HTML structure
      run: |
        echo "üîç Validation de index.html..."
        
        # V√©rifier que le fichier existe
        if [ ! -f "index.html" ]; then
          echo "‚ùå ERREUR: index.html manquant"
          exit 1
        fi
        
        # V√©rifier le doctype (CRITIQUE)
        if ! grep -q "<!DOCTYPE html>" index.html; then
          echo "‚ùå ERREUR: Doctype HTML manquant (obligatoire)"
          exit 1
        else
          echo "‚úÖ Doctype HTML pr√©sent"
        fi
        
        # V√©rifier les balises essentielles
        if ! grep -q "<title>" index.html; then
          echo "‚ö†Ô∏è  Warning: Balise <title> manquante (SEO impact√©)"
        else
          echo "‚úÖ Titre pr√©sent"
        fi
        
        # V√©rifier la viewport (mobile)
        if ! grep -q "viewport" index.html; then
          echo "‚ö†Ô∏è  Warning: Viewport manquant (mobile non optimis√©)"
        else
          echo "‚úÖ Viewport pr√©sent"
        fi
        
        # V√©rifier charset
        if ! grep -q "charset=" index.html; then
          echo "‚ö†Ô∏è  Warning: Charset manquant (encodage)"
        else
          echo "‚úÖ Charset pr√©sent"
        fi
        
        # V√©rifier si c'est un site statique complet
        FILE_SIZE=$(stat -f%z index.html 2>/dev/null || stat -c%s index.html 2>/dev/null)
        echo "üìè Taille de index.html: $FILE_SIZE octets"
        
        if [ $FILE_SIZE -lt 1000 ]; then
          echo "‚ö†Ô∏è  Warning: index.html tr√®s petit (<1KB)"
        fi
    
    - name: Run tests
      run: |
        # Ex√©cuter npm test s'il existe, sinon simuler
        if grep -q '"test"' package.json; then
          npm test
        else
          echo "‚úÖ Tests simul√©s - package.json n'a pas de script test"
          echo "Pour ajouter des tests: ajouter 'test' dans scripts de package.json"
        fi
    
    - name: Build site
      run: |
        # Cr√©er le dossier dist
        mkdir -p dist
        
        # Copier index.html
        cp index.html dist/
        
        # Copier les autres fichiers s'ils existent
        for file in *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg; do
          if [ -f "$file" ]; then
            cp "$file" dist/
            echo "üìÑ Copi√©: $file"
          fi
        done
        
        echo "üìÅ Structure du dossier dist:"
        find dist -type f | sed 's/^/  /'
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: website-build
        path: dist/
        retention-days: 7
    
    - name: Display success message
      run: |
        echo ""
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë     üéâ CI PIPELINE R√âUSSI !         ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "üìä R√©sum√©:"
        echo "  ‚úÖ HTML structure valid√©e"
        echo "  ‚úÖ D√©pendances install√©es"
        echo "  ‚úÖ Build cr√©√© dans dist/"
        echo "  üì¶ Artefact t√©l√©chargeable"
        echo ""
        echo "Prochaine √©tape: Merge sur main pour d√©clencher le d√©ploiement"